# アプリ側での学術論文検索統合テスト

## 概要

`test_app_academic_integration.py`は、Streamlitアプリの実際のフローを再現し、学術論文検索が正しく動作し、開発戦略レポートに反映されているかを確認するためのテストスクリプトです。

## 前提条件

1. 仮想環境がアクティベートされていること
2. 必要なライブラリがインストールされていること（`requirements.txt`参照）
3. 環境変数が設定されていること（`.env`ファイル参照）
   - `GEMINI_API_KEY`: Gemini APIキー（必須）

## 基本的な使用方法

### クイックテスト（推奨）

市場調査エージェントでの学術論文検索のみをテストします（約1-2分）：

```bash
# 仮想環境をアクティベート
source venv/bin/activate

# デフォルトのクエリでテスト
python test_app_academic_integration.py --quick

# カスタム技術タグでテスト
python test_app_academic_integration.py --quick --tech-tags polymer "heat resistance"

# 日本語の技術タグでテスト
python test_app_academic_integration.py --quick --tech-tags ポリマー 耐熱性
```

### フルテスト

イノベーション分隊のフルフローをテストします（約5-10分、LLM呼び出しを含む）：

```bash
# デフォルトのデータでテスト
python test_app_academic_integration.py

# カスタムデータでテスト
python test_app_academic_integration.py \
  --company-name "旭日自動車株式会社" \
  --department "研究開発部" \
  --tech-tags polymer "heat resistance" automotive \
  --interview-memo "顧客から高温環境下でも劣化しないポリマー材料の開発依頼がありました。"
```

## テスト内容

### テスト1: 市場調査エージェントでの学術論文検索

- arXiv APIを使用した学術論文検索の動作確認
- 検索結果の取得と表示
- `format_arxiv_results()`関数による文字列フォーマットの確認
- 市場調査エージェント全体の実行
- 学術論文情報が市場調査サマリーに含まれているかの確認

**確認ポイント**:
- ✅ 学術論文が正しく取得される
- ✅ フォーマット関数が正しく動作する
- ✅ 市場調査サマリーに学術論文情報が含まれる

### テスト2: イノベーション分隊フルフロー

- イノベーション分隊の完全なフローを実行
- 最終レポートの生成
- レポートに学術論文情報が反映されているかの確認

**確認ポイント**:
- ✅ 最終レポートが生成される
- ✅ レポートに学術論文関連のキーワードが含まれる
- ✅ レポートの構造が正しい（Markdown形式、セクション構成）

## 実行例

### クイックテストの実行例

```bash
$ python test_app_academic_integration.py --quick --tech-tags polymer "heat resistance"

================================================================================
  アプリ側での学術論文検索統合テスト
================================================================================

================================================================================
  テスト1: 市場調査エージェントでの学術論文検索
================================================================================
技術タグ: ['polymer', 'heat resistance']
用途: 顧客から、高温環境下でも劣化しないポリマー材料の開発依頼がありました...

📚 arXiv検索クエリ: 'polymer heat resistance'
✅ 5件の学術論文を取得しました。

【論文1】
  タイトル: Velocity jump in the crack propagation...
  著者: Takako Tomizawa, Ko Okumura
  公開日: 2019-04-05
  リンク: http://arxiv.org/abs/1904.03250v1

...

✅ 学術論文の情報が市場調査サマリーに含まれています。
================================================================================
テスト結果サマリー
================================================================================
✅ PASS: 市場調査エージェント

合計: 1/1 テストが成功しました。
```

### フルテストの実行例

```bash
$ python test_app_academic_integration.py --company-name "テスト企業" --tech-tags polymer

================================================================================
  アプリ側での学術論文検索統合テスト
================================================================================

[テスト1の出力...]

================================================================================
  テスト2: イノベーション分隊フルフロー
================================================================================
企業名: テスト企業
事業部: 研究開発部
技術タグ: ['polymer', 'heat resistance']
面談メモ（最初の200文字）: 顧客から、高温環境下でも劣化しない...

🚀 イノベーション分隊を実行中...
   （この処理には時間がかかる場合があります）

✅ イノベーション分隊が完了しました。

📄 最終レポート（最初の2000文字）:
--------------------------------------------------------------------------------
# 開発戦略レポート

## Trigger
...

## Market Trend
...

✅ レポートに学術論文関連のキーワードが見つかりました: ['論文', '研究']
✅ Markdown形式の見出しが含まれています。
✅ Marketセクションが含まれています。
✅ Proposalセクションが含まれています。

================================================================================
テスト結果サマリー
================================================================================
✅ PASS: 市場調査エージェント
✅ PASS: イノベーション分隊フルフロー

合計: 2/2 テストが成功しました。
```

## 確認できること

### 1. 学術論文検索の動作確認

- arXiv APIへの接続が正常に動作する
- 検索クエリが正しく構築される
- 検索結果が正しい形式で返される
- ログ出力が正しく記録される

### 2. データフローの確認

- 学術論文検索 → フォーマット → 市場調査エージェント → レポート生成の流れが正しく動作する
- 各段階でデータが正しく変換される

### 3. レポートへの反映確認

- 市場調査サマリーに学術論文情報が含まれる
- 最終レポートに学術論文関連の情報が反映される
- レポートの構造が正しい

## トラブルシューティング

### GEMINI_API_KEYが設定されていない

**エラーメッセージ**:
```
ValueError: GEMINI_API_KEY が設定されていません
```

**解決方法**:
```bash
# .envファイルに設定
echo "GEMINI_API_KEY=your_api_key_here" >> .env

# または環境変数として設定
export GEMINI_API_KEY=your_api_key_here
```

### ネットワークエラー

**エラーメッセージ**:
```
arXiv検索エラー: Connection timeout
```

**解決方法**:
- ネットワーク接続を確認
- ファイアウォール設定を確認
- しばらく時間をおいて再試行

### 検索結果が0件

**原因**:
- クエリがarXivに存在しない
- 技術タグが適切でない

**解決方法**:
- より一般的なキーワードで試す
- 英語のキーワードを使用する
- 複数のキーワードを組み合わせる

### Streamlitのモックエラー

**エラーメッセージ**:
```
AttributeError: 'module' object has no attribute 'chat_message'
```

**解決方法**:
- スクリプト内でStreamlitが正しくモックされているか確認
- 最新バージョンのスクリプトを使用

## コマンドライン引数

| 引数 | 説明 | デフォルト値 |
|------|------|-------------|
| `--interview-memo` | 面談メモ | サンプルデータ |
| `--tech-tags` | 技術タグ（スペース区切り） | `["polymer", "heat resistance"]` |
| `--department` | 事業部名 | `"研究開発部"` |
| `--company-name` | 企業名 | `"テスト企業"` |
| `--quick` | クイックテストモード | `False` |

## CI/CDでの使用

継続的インテグレーションで使用する場合：

```bash
# クイックテストのみ実行（高速）
python test_app_academic_integration.py --quick && echo "Tests passed" || exit 1
```

## 関連ファイル

- `services/academic.py`: 学術論文検索の実装
- `services/multi_agent.py`: マルチエージェントシステム
- `test_academic_search.py`: 単体テストスクリプト
- `docs/academic_search.md`: 実装の詳細ドキュメント

## 注意事項

1. **APIキー**: Gemini APIキーが必要です。無料枠でも動作しますが、レート制限に注意してください。

2. **実行時間**: 
   - クイックテスト: 約1-2分
   - フルテスト: 約5-10分（LLM呼び出しを含む）

3. **コスト**: フルテストではLLM（Gemini）を呼び出すため、API使用料が発生する可能性があります。

4. **ネットワーク**: arXiv APIとDuckDuckGo検索にインターネット接続が必要です。

